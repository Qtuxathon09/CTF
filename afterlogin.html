<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAvOC CTF | User Dashboard</title>
    <!-- Load Tailwind CSS and Font Awesome -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* CSS Variables - CTF Theme */
        :root {
            /* Core Colors - CTF Theme */
            --background: #0b0b0b;
            --foreground: #ffffff;
            
            /* Neon Red Palette */
            --neon-red: #ff2b2b;
            --neon-red-glow: #ff2b2b;
            
            /* Glass System */
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-bg-dark: rgba(0, 0, 0, 0.3);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-red: rgba(255, 43, 43, 0.1);

            /* Fonts & Aesthetics */
            --font-body: 'JetBrains Mono', monospace;
            --font-heading: 'Orbitron', monospace;
            --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --shadow-glass: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            --shadow-neon: 0 0 20px rgba(255, 43, 43, 0.5);
            --radius: 1rem;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-body);
            background: var(--background);
            color: var(--foreground);
            line-height: 1.6;
            min-height: 100vh;
            /* Padding for fixed header */
            padding-top: 6rem;
            padding-bottom: 4rem;
            overflow-x: hidden;
        }

        .scanlines::after {
            content: "";
            position: fixed; 
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                transparent 98%,
                rgba(255, 43, 43, 0.03) 100%
            );
            background-size: 100% 4px;
            pointer-events: none;
            animation: scanlines 2s linear infinite;
            z-index: 0;
        }

        @keyframes scanlines {
            0% { transform: translateY(0); }
            100% { transform: translateY(4px); }
        }

        body {
            background-image: radial-gradient(circle at 20% 30%, rgba(255, 43, 43, 0.1) 0%, transparent 50%),
                              radial-gradient(circle at 80% 70%, rgba(255, 43, 43, 0.05) 0%, transparent 50%);
        }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; z-index: 10; position: relative; }

        /* --- UI Components (Matching Challenges Styles) --- */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-glass);
            border-radius: var(--radius);
            transition: var(--transition-smooth);
        }
        
        .glass-card:hover {
            transform: translateY(-4px);
            border-color: var(--neon-red);
            background: rgba(255, 43, 43, 0.05);
        }

        .neon-text {
            color: var(--neon-red);
            text-shadow: 0 0 10px rgba(255, 43, 43, 0.8);
        }
        .neon-success {
            color: #22c55e;
            text-shadow: 0 0 8px rgba(34, 197, 94, 0.5);
        }

        /* Toast Container Styles */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column-reverse;
            gap: 10px;
        }
        .toast {
            background-color: var(--glass-bg-dark);
            color: var(--foreground);
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: var(--shadow-glass);
            border-left: 5px solid;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.5s ease-out;
            max-width: 300px;
        }
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        .toast.success { border-left-color: #22c55e; }
        .toast.error { border-left-color: var(--neon-red); }

        /* --- NAVIGATION STYLES (New Header) --- */
        .nav-glass {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: var(--glass-bg-dark);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem 0;
        }

        .nav-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-brand .logo {
            font-family: var(--font-heading);
            font-weight: 900;
            font-size: 1.5rem;
            color: var(--neon-red);
            text-shadow: 0 0 10px rgba(255, 43, 43, 0.8);
        }
        
        .nav-links-group {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .nav-link {
            color: var(--foreground);
            text-decoration: none;
            transition: var(--transition-smooth);
            position: relative;
            font-family: var(--font-body);
            font-weight: 500;
        }

        .nav-link:hover,
        .nav-link.active {
            color: var(--neon-red);
            text-shadow: 0 0 5px rgba(255, 43, 43, 0.8);
        }

        .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--neon-red);
            box-shadow: 0 0 5px rgba(255, 43, 43, 0.8);
        }
        
        /* Logout Button Style (Inline with nav links) */
        #signOutBtnNav {
            text-red-neon: var(--neon-red);
            border-color: var(--neon-red);
            color: var(--neon-red);
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
            border-radius: 0.5rem;
            font-weight: 700;
            transition: var(--transition-smooth);
            background: transparent;
            border: 1px solid;
            cursor: pointer;
            margin-left: 1rem;
        }
        #signOutBtnNav:hover {
            background: var(--neon-red);
            color: var(--background);
            box-shadow: var(--shadow-neon);
        }


        /* --- Main Header --- */
        .main-header {
            text-align: center;
            margin-bottom: 3rem;
        }
        .dashboard-title {
            font-family: var(--font-heading);
            font-size: clamp(2rem, 5vw, 4rem);
            font-weight: 900;
            color: var(--neon-red);
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 5px var(--neon-red), 0 0 10px rgba(255, 43, 43, 0.8);
        }

        .dashboard-subtitle {
            font-size: 1.2rem;
            color: var(--foreground);
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 0.5rem;
        }
        
        /* --- Buttons --- */
        .btn-primary {
            background: var(--glass-red);
            border: 2px solid var(--neon-red);
            color: var(--foreground);
            padding: 10px 20px;
            border-radius: var(--radius);
            font-family: var(--font-body);
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition-smooth);
            text-decoration: none;
            box-shadow: var(--shadow-neon);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .btn-primary:hover {
            background: var(--neon-red);
            color: var(--background);
            box-shadow: 0 0 25px rgba(255, 43, 43, 0.8);
            transform: translateY(-1px);
        }
        
        /* Form/Input Styles */
        #teamNameInput,
        #inviteForm input[type="email"] {
            padding: 0.75rem;
            background: var(--glass-bg-dark);
            border: 1px solid var(--glass-border);
            color: var(--foreground);
            border-radius: 0.5rem; /* half radius */
            outline: none;
            flex-grow: 1;
        }
        #teamNameInput:focus,
        #inviteForm input[type="email"]:focus {
            border-color: var(--neon-red);
            box-shadow: 0 0 0 2px rgba(255, 43, 43, 0.3);
        }

        /* Invitation/Member List Style */
        .member-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-left: 3px solid var(--neon-red);
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
        }
        .invite-card {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding: 1rem;
            border-left: 5px solid #22c55e;
            background: rgba(34, 197, 94, 0.1);
            border-radius: var(--radius);
        }
        .invite-card.removed {
            border-left: 5px solid var(--neon-red);
            background: rgba(255, 43, 43, 0.1);
        }
        .invite-card .actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Responsive Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }
        
        .module-title {
            font-family: var(--font-heading);
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        /* Hide the old inline header elements */
        .main-header > .flex:first-child {
            display: none;
        }
        
        /* Mobile adjustment for nav */
        @media (max-width: 768px) {
            .nav-links-group {
                display: none;
            }
        }
        
        /* Leave Team Button */
        #leaveTeamBtn {
            background-color: transparent;
            color: #ef4444; /* Neon red text */
            border: 1px solid #ef4444;
            padding: 8px 16px;
            border-radius: 0.5rem;
            font-weight: 700;
            transition: all 0.2s ease;
            cursor: pointer;
            text-transform: uppercase;
        }
        #leaveTeamBtn:hover {
            background-color: #ef4444;
            color: var(--background);
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.6);
        }
        /* Remove Button for leader */
        .remove-member-btn {
            background: var(--glass-bg-dark);
            border: 1px solid #ef4444;
            color: #ef4444;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: var(--transition-smooth);
        }
        .remove-member-btn:hover {
            background: #ef4444;
            color: var(--background);
        }

    </style>
</head>
<body class="scanlines">
    
    <!-- NAVIGATION HEADER (Based on your image) -->
    <nav class="nav-glass">
        <div class="container nav-content">
            <!-- Logo -->
            <div class="nav-brand">
                <span class="logo">HAvOC<span class="neon-text">CTF</span></span>
            </div>
            
            <!-- Links and Logout -->
            <div class="nav-links-group">
                <!-- <a href="index copy.html" class="nav-link">Home</a> -->
                <a href="afterlogin.html" class="nav-link active">Dashboard</a>
                <a href="challenges.html" class="nav-link">Challenges</a>
                <a href="scoreboard.html" class="nav-link">Scoreboard</a>
                <a href="rules.html" class="nav-link">Rules</a>
                
                <!-- Logout Button (replaces the top-right button) -->
                <button id="signOutBtnNav" type="button" class="flex items-center gap-1">
                    <i class="fas fa-sign-out-alt"></i> LOGOUT
                </button>
            </div>
            
        </div>
    </nav>
    
    <div class="container">
        
        <!-- The old top-right logout button is now hidden via CSS/JS -->
        <div class="main-header" style="margin-top: 0;">
             <h1 class="dashboard-title">HACKER DASHBOARD</h1>
             <p class="dashboard-subtitle">Control Panel for User Authentication and Team Management</p>
        </div>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            
            <!-- 1. Profile Module -->
            <div id="profile-module" class="glass-card p-6 md:p-8">
                <h3 class="module-title neon-text flex items-center gap-2"><i class="fas fa-user-circle"></i> Profile Status</h3>
                <div class="space-y-3">
                    <p><strong>Username:</strong> <span id="userProfileUsername" class="neon-success">Loading...</span></p>
                    <p><strong>Email:</strong> <span id="userProfileEmail" class="text-gray-400">Loading...</span></p>
                    <p><strong>Total Score:</strong> <span id="userProfileScore" class="neon-text">0</span> pts</p>
                    <p class="text-xs opacity-50 break-all"><strong>UID:</strong> <span id="userProfileUID"></span></p>
                </div>
            </div>

            <!-- 2. Challenges Module -->
             <div id="challenges-module" class="glass-card p-6 md:p-8">
                <h3 class="module-title neon-text flex items-center gap-2"><i class="fas fa-terminal"></i> Challenge Access</h3>
                <p class="opacity-75 mb-4">
                    Jump directly into the challenges and start earning points.
                </p>
                <a href="challenges.html" class="btn-primary inline-flex items-center gap-2">
                    <i class="fas fa-arrow-alt-circle-right"></i> Go to Challenges
                </a>
            </div>
            
            <!-- 3. Notifications Module -->
            <div id="notifications-module" class="glass-card p-6 md:p-8">
                <h3 class="module-title neon-text flex items-center gap-2">
                    <i class="fas fa-bell"></i> Notifications (<span id="notifCount" class="neon-text">0</span>)
                </h3>
                <div id="invitationList" class="space-y-4 text-sm">
                    <p class="opacity-75" id="noInvitesMessage">You have no pending team invitations.</p>
                    <!-- Invitation cards will be inserted here -->
                </div>
            </div>

            <!-- 4. Team Hub Module -->
            <div id="team-hub-module" class="glass-card p-6 md:p-8 col-span-1 md:col-span-2">
                <h3 class="module-title neon-text flex items-center gap-2"><i class="fas fa-users"></i> Team Hub</h3>
                
                <!-- No Team State -->
                <div id="teamStatusDisplay">
                    <div id="teamCreationFormContainer">
                        <p class="text-lg mb-4">You currently **do not belong** to a team.</p>
                        <form id="createTeamForm" class="flex flex-col md:flex-row gap-3 items-end">
                            <input type="text" id="teamNameInput" placeholder="Enter Team Name (e.g., CyberRebels)" required minlength="4" class="flex-grow">
                            <button type="submit" class="btn-primary w-full md:w-auto flex items-center justify-center gap-2">
                                <i class="fas fa-plus-circle"></i> Create Team Now
                            </button>
                        </form>
                        <div id="createTeamMessage" class="team-message hidden text-sm mt-3"></div>
                    </div>
                </div>

                <!-- Team Leader/Member Details State -->
                <div id="teamDetailsArea" class="hidden">
                    <h3 class="text-2xl font-bold mb-4 neon-success" id="teamNameDisplay" style="font-family: var(--font-heading);">TEAM_NAME</h3>
                    <p><strong>Team Leader:</strong> <span id="teamLeaderName" class="text-white opacity-80"></span></p>
                    <p class="mb-4"><strong>Team Score:</strong> <span id="teamScore" class="neon-text">0</span> pts</p>

                    <div id="inviteSection" class="mt-8">
                        <h4 class="text-xl font-bold mt-6 mb-3 neon-text" style="font-family: var(--font-heading);">Invite New Member</h4>
                        <div id="inviteMessage" class="team-message hidden text-sm"></div>
                        <form id="inviteForm" class="flex flex-col md:flex-row gap-3 items-end">
                            <input type="email" id="inviteEmail" placeholder="Enter email of registered user" required class="flex-grow">
                            <button type="submit" class="btn-primary w-full md:w-auto flex items-center justify-center gap-2">
                                <i class="fas fa-paper-plane"></i> Send Invite
                            </button>
                        </form>
                    </div>

                    <h4 class="text-xl font-bold mt-8 mb-3 neon-text" style="font-family: var(--font-heading);">Current Members</h4>
                    <ul id="teamMemberList" class="space-y-2 list-none p-0">
                        <!-- Members populated by script -->
                    </ul>
                    
                    <!-- LEAVE TEAM BUTTON -->
                    <div class="mt-6 flex justify-end">
                         <button id="leaveTeamBtn" type="button">
                            <i class="fas fa-sign-out-alt"></i> Leave Team
                        </button>
                    </div>
                </div>
            </div>

        </div> <!-- End of Dashboard Grid -->
        
    </div> <!-- End of Container -->
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Firebase Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            collection, 
            query, 
            where, 
            getDocs,
            addDoc,
            arrayUnion,
            arrayRemove, // ADDED: Required for leaving team
            serverTimestamp,
            writeBatch,
            deleteDoc,
            onSnapshot
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CANVAS GLOBAL VARIABLES (MUST BE USED) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            // Using a default fallback structure for demonstration/testing
            apiKey: "AIzaSyDIamHzhka0fwSE1WtAQVLCcbruT5b7UZk",
            authDomain: "havoc-985d0.firebaseapp.com",
            databaseURL: "https://havoc-985d0-default-rtdb.firebaseio.com",
            projectId: "havoc-985d0",
            storageBucket: "havoc-985d0.firebasestorage.app",
            messagingSenderId: "8269389875",
            appId: "1:8269389875:web:1fa7fb79185a3f31dc4346",
            measurementId: "G-Y6FXWB2RWY"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        const APP_ID = firebaseConfig.projectId; 
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global State ---
        let currentUsername = "USER";
        let userTeamId = null;
        let userTeamName = null;
        let userIsTeamLeader = false;
        let unsubscribeTeamListener = null; // New global to hold the real-time listener

        // --- DOM Elements ---
        const signOutBtnNav = document.getElementById('signOutBtnNav');
        const leaveTeamBtn = document.getElementById('leaveTeamBtn'); // ADDED
        
        const teamStatusDisplay = document.getElementById('teamStatusDisplay');
        const teamDetailsArea = document.getElementById('teamDetailsArea');
        const teamNameDisplay = document.getElementById('teamNameDisplay');
        const teamLeaderName = document.getElementById('teamLeaderName');
        const teamScore = document.getElementById('teamScore');
        const teamMemberList = document.getElementById('teamMemberList');
        const inviteForm = document.getElementById('inviteForm');
        const inviteMessage = document.getElementById('inviteMessage');
        const invitationList = document.getElementById('invitationList');
        const noInvitesMessage = document.getElementById('noInvitesMessage');
        const notifCount = document.getElementById('notifCount');
        const inviteSection = document.getElementById('inviteSection'); 
        const createTeamForm = document.getElementById('createTeamForm');
        const createTeamMessage = document.getElementById('createTeamMessage');

        // --- Utility Functions ---
        
        /** Shows a persistent toast notification. */
        const toastContainer = document.getElementById('toastContainer');
        function showToast(type, message) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span class="font-bold">${type.toUpperCase()}:</span> ${message}`;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 500);
            }, 5000);
        }

        /** Fetches the username from the user's private profile. */
        async function fetchUsername(userId) {
            try {
                const userProfileRef = doc(db, `/artifacts/${APP_ID}/users/${userId}/user_profiles/profile`);
                const docSnap = await getDoc(userProfileRef);
                return docSnap.exists() && docSnap.data().username ? docSnap.data().username : auth.currentUser?.email?.split('@')[0] || "USER";
            } catch (error) {
                console.error("Error fetching username:", error);
                return auth.currentUser?.email?.split('@')[0] || "USER";
            }
        }
        
        /** Checks if a user is currently in ANY team (one-time read). Used for invite acceptance validation. */
        async function checkIfUserInAnyTeam(userId, username) {
            const teamsRef = collection(db, `/artifacts/${APP_ID}/public/data/teams`);
            // We search for a team where the user object is already present in the members array.
            const q = query(teamsRef, where("members", "array-contains", { uid: userId, name: username.toLowerCase(), email: auth.currentUser.email }));
            const snapshot = await getDocs(q);
            return !snapshot.empty;
        }

        /** Renders the team details view or the "no team" message. */
        function renderTeamView(teamData) {
            if (teamData) {
                // If team data exists, show the details view and hide the default message
                teamStatusDisplay.classList.add('hidden');
                teamDetailsArea.classList.remove('hidden');

                // Populate team details
                teamNameDisplay.textContent = teamData.name.toUpperCase();
                teamLeaderName.textContent = teamData.leaderName.toUpperCase();
                teamScore.textContent = teamData.score || 0; // Display score, default to 0

                // Render members list
                teamMemberList.innerHTML = ''; // Clear existing members
                teamData.members.forEach(member => {
                    const isLeader = member.uid === teamData.leaderId;
                    const li = document.createElement('li');
                    li.className = `member-item`;
                    li.innerHTML = `
                        <span>
                            <i class="fas fa-user mr-2 ${isLeader ? 'neon-text' : 'text-white/70'}"></i>
                            ${member.name.toUpperCase()} 
                            ${isLeader ? ' <span class="text-xs neon-text">(Leader)</span>' : ''}
                        </span>
                        ${userIsTeamLeader && !isLeader ? 
                            `<button class="remove-member-btn" 
                                     data-member-uid="${member.uid}" 
                                     data-member-name="${member.name}"
                                     data-member-email="${member.email}"
                                     data-action="remove">
                                <i class="fas fa-user-minus"></i> Remove
                            </button>` 
                            : ''}
                    `;
                    teamMemberList.appendChild(li);
                });
                
                // Only leader can see invite section. Everyone can see leave button.
                inviteSection.classList.toggle('hidden', !userIsTeamLeader);
            } else {
                // If no team data, show the default team creation message
                teamStatusDisplay.classList.remove('hidden');
                teamDetailsArea.classList.add('hidden');
            }
        }

        /** Subscribes to the user's team status in real-time. */
        function listenForTeamStatus(userId, username) {
            // Cleanup previous listener to prevent memory leaks
            if (unsubscribeTeamListener) {
                unsubscribeTeamListener();
            }

            const teamsRef = collection(db, `/artifacts/${APP_ID}/public/data/teams`);
            
            // CRITICAL FIX: Query for a team where the user's unique member object exists in the 'members' array
            // ENSURE the member object used here is identical to the one stored during creation/acceptance.
            const q = query(teamsRef, where("members", "array-contains", { uid: userId, name: username.toLowerCase(), email: auth.currentUser.email.toLowerCase() }));

            // Set up the real-time listener
            unsubscribeTeamListener = onSnapshot(q, (snapshot) => {
                if (!snapshot.empty) {
                    const teamDoc = snapshot.docs[0];
                    const teamData = teamDoc.data();
                    
                    // Update global state variables
                    userTeamId = teamDoc.id;
                    userTeamName = teamData.name;
                    userIsTeamLeader = teamData.leaderId === userId;
                    
                    renderTeamView(teamData); // Update the UI with new team data
                } else {
                    // Reset global state if the user is no longer in a team
                    userTeamId = null;
                    userTeamName = null;
                    userIsTeamLeader = false;
                    renderTeamView(null); // Show the "No Team" UI
                }
            }, (error) => {
                console.error("Error listening to team status:", error);
                // On error, revert to no team view
                userTeamId = null;
                userTeamName = null;
                userIsTeamLeader = false;
                renderTeamView(null);
            });
        }
        
        /** Renders the invitations list in the notifications tab. */
        function renderInvitations(invites) {
            invitationList.innerHTML = ''; // Clear old invites
            // Filter out removal messages from the count
            const pendingInvites = invites.filter(i => i.status === 'pending');
            notifCount.textContent = pendingInvites.length; // Update notification counter

            if (invites.length === 0) {
                noInvitesMessage.classList.remove('hidden');
                invitationList.appendChild(noInvitesMessage);
                return;
            }
            
            noInvitesMessage.classList.add('hidden'); // Hide "no invites" message

            invites.forEach(invite => {
                const isPending = invite.status === 'pending';
                const isRemoved = invite.status === 'removed';
                
                const card = document.createElement('div');
                card.className = `invite-card ${isRemoved ? 'removed' : ''}`;
                
                let cardContent;

                if (isRemoved) {
                    // Content for a removal notification
                     cardContent = `
                        <div class="flex flex-col gap-1">
                            <p class="font-bold text-base neon-text">Team Removal Notice</p>
                            <p class="text-xs opacity-75">
                                You were **removed** from team <strong>${invite.teamName.toUpperCase()}</strong> by the leader.
                            </p>
                        </div>
                        <div class="actions flex justify-end">
                             <button class="remove-notification-btn bg-gray-600 hover:bg-gray-700 border-gray-500 text-xs" style="padding: 0.5rem 1rem;" data-action="remove-notif" data-invite-id="${invite.id}">DISMISS</button>
                        </div>
                    `;
                } else if (isPending) {
                    // Content for a pending invitation
                    cardContent = `
                        <div class="flex flex-col gap-1">
                            <p class="font-bold text-base neon-text">Team Invitation</p>
                            <p class="text-xs opacity-75">
                                Team <strong>${invite.teamName.toUpperCase()}</strong> invites you to join, from ${invite.inviterName.toUpperCase()}.
                            </p>
                        </div>
                        <div class="actions flex gap-2 justify-end">
                            <button class="btn-primary bg-green-600 hover:bg-green-700 border-green-500 text-xs" style="padding: 0.5rem 1rem;" data-action="accept" data-invite-id="${invite.id}" data-team-id="${invite.teamId}">ACCEPT</button>
                            <button class="btn-primary bg-gray-600 hover:bg-gray-700 border-gray-500 text-xs" style="padding: 0.5rem 1rem;" data-action="decline" data-invite-id="${invite.id}">DECLINE</button>
                        </div>
                    `;
                }
                
                card.innerHTML = cardContent;
                invitationList.appendChild(card);
            });
        }
        
        /** Subscribes to real-time invitations for the current user's email. */
        function listenForInvitations() {
            if (!auth.currentUser || !auth.currentUser.email) return;

            const invitesRef = collection(db, `/artifacts/${APP_ID}/public/data/invitations`);
            // Query filters for pending invitations AND removal notices sent to the current user's email
            const q = query(invitesRef, where("inviteeEmail", "==", auth.currentUser.email.toLowerCase()));
            
            // Start the listener
            onSnapshot(q, (snapshot) => {
                const invitations = [];
                snapshot.forEach(doc => {
                    invitations.push({ id: doc.id, ...doc.data() });
                });
                renderInvitations(invitations); // Update the invitations UI
            }, (error) => {
                console.error("Error listening to invitations:", error);
            });
        }

        // --- Core Authentication/Load Handler ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userId = user.uid;
                
                // CRITICAL: Ensure currentUsername is stored and used in lowercase globally for Firestore queries
                currentUsername = (await fetchUsername(userId)).toLowerCase(); 
                
                // Update Profile Card
                document.getElementById('userProfileUsername').textContent = currentUsername.toUpperCase();
                document.getElementById('userProfileEmail').textContent = user.email.toLowerCase(); // Display lowercase email
                document.getElementById('userProfileUID').textContent = userId;

                // Start the real-time listener for team status (Crucial for instant update after joining)
                listenForTeamStatus(userId, currentUsername);

                listenForInvitations(); // Start real-time invite listener

            } else {
                // User is logged out: clean up and redirect
                if (unsubscribeTeamListener) {
                    unsubscribeTeamListener();
                    unsubscribeTeamListener = null;
                }
                // FIX: Use window.location.href for immediate redirect compatibility
                window.location.href = 'login.html'; 
            }
        });

        // --- Event Handlers ---

        // 1. Logout
        signOutBtnNav.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showToast('success', 'Logged out successfully.');
            } catch (error) {
                console.error("Logout failed:", error);
            }
        });
        
        // 2. Team Creation Submission
        createTeamForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const teamName = document.getElementById('teamNameInput').value.trim();
            const submitButton = createTeamForm.querySelector('button');

            if (!auth.currentUser) {
                showToast('error', "Authentication required to create a team.");
                return;
            }
            if (userTeamId) {
                 showToast('error', `You already belong to team ${userTeamName.toUpperCase()}.`);
                 return;
            }

            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> CREATING...';
            createTeamMessage.classList.remove('message-error', 'message-success', 'hidden');
            createTeamMessage.textContent = '';
            
            try {
                // 1. Prepare Team Data
                const userId = auth.currentUser.uid;
                const userEmail = auth.currentUser.email.toLowerCase(); 
                const leaderName = currentUsername.toLowerCase(); // Use consistent lowercase name

                const teamData = {
                    name: teamName,
                    leaderId: userId,
                    leaderName: leaderName,
                    members: [{ uid: userId, name: leaderName, email: userEmail }], // Store consistent object structure
                    score: 0,
                    createdAt: serverTimestamp()
                };

                // 2. Store in /artifacts/{appId}/public/data/teams
                const teamsRef = collection(db, `/artifacts/${APP_ID}/public/data/teams`);
                await addDoc(teamsRef, teamData);

                showToast('success', `Team ${teamName.toUpperCase()} created successfully!`);
                document.getElementById('teamNameInput').value = ''; 
                // UI updates are handled by the listenForTeamStatus onSnapshot listener

            } catch (error) {
                console.error("Team creation failed:", error);
                createTeamMessage.classList.add('message-error');
                createTeamMessage.textContent = 'Team creation failed. Try a different name or check permissions.';
                showToast('error', 'Team creation failed.');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-plus-circle"></i> Create Team Now';
            }
        });


        // 3. Team Invitation Submission
        inviteForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const inviteEmail = document.getElementById('inviteEmail').value.trim().toLowerCase();
            const submitButton = inviteForm.querySelector('button');
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> SENDING...';

            if (!auth.currentUser || !userIsTeamLeader || !userTeamId) {
                showToast('error', "Not authorized to send invites or missing team info.");
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-paper-plane"></i> Send Invite';
                return;
            }

            if (inviteEmail === auth.currentUser.email.toLowerCase()) {
                showToast('error', 'Cannot invite yourself.');
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-paper-plane"></i> Send Invite';
                return;
            }

            try {
                // Check if the invited user is already a member of *this* team
                const teamDocSnap = await getDoc(doc(db, `/artifacts/${APP_ID}/public/data/teams`, userTeamId));
                if (teamDocSnap.exists()) {
                    const members = teamDocSnap.data().members;
                    if (members.some(member => member.email === inviteEmail)) {
                        showToast('error', 'This user is already a member of your team.');
                        submitButton.disabled = false;
                        submitButton.innerHTML = '<i class="fas fa-paper-plane"></i> Send Invite';
                        return;
                    }
                }

                // Create a Public Invitation Record
                const invitationsRef = collection(db, `/artifacts/${APP_ID}/public/data/invitations`);
                await addDoc(invitationsRef, {
                    inviteeEmail: inviteEmail, // Store lowercase email
                    teamId: userTeamId,
                    teamName: userTeamName,
                    inviterName: currentUsername, // Uses lowercase name
                    status: 'pending',
                    timestamp: serverTimestamp()
                });

                showToast('success', `Invite sent to ${inviteEmail}!`);
                document.getElementById('inviteEmail').value = '';

            } catch (error) {
                console.error("Error sending invite:", error);
                showToast('error', 'Failed to send invite. Try again or check the email.');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-paper-plane"></i> Send Invite';
            }
        });

        // 4. Accept/Decline/Dismiss Invitation/Notice
        invitationList.addEventListener('click', async (e) => {
            const target = e.target;
            const action = target.dataset.action;
            const inviteId = target.dataset.inviteId;
            const teamId = target.dataset.teamId;

            // Basic validation
            if (!action || !inviteId || !auth.currentUser) return;

            // Disable button to prevent double-click
            if (target.disabled) return;
            target.disabled = true;
            target.textContent = 'Processing...';

            const inviteRef = doc(db, `/artifacts/${APP_ID}/public/data/invitations`, inviteId);
            const teamRef = doc(db, `/artifacts/${APP_ID}/public/data/teams`, teamId);
            const userId = auth.currentUser.uid;
            const userEmail = auth.currentUser.email.toLowerCase();

            try {
                if (action === 'accept') {
                    // Fetch the user's latest username (already stored in currentUsername, which is lowercase)
                    const currentUserName = currentUsername; 
                    
                    // Check if they are already in *any* team before joining a new one
                    const isAlreadyInTeam = await checkIfUserInAnyTeam(userId, currentUserName);

                    if (isAlreadyInTeam) {
                        showToast('error', "You must leave your current team before joining a new one.");
                        target.disabled = false;
                        target.textContent = 'ACCEPT';
                        return;
                    }
                    
                    const batch = writeBatch(db);

                    // 1. Add the user to the team's members array
                    // CRITICAL FIX: Ensure the member object includes the lowercase email for consistency
                    const newMember = { uid: userId, name: currentUserName, email: userEmail };
                    batch.update(teamRef, {
                        members: arrayUnion(newMember)
                    });
                    
                    // 2. Delete the invitation
                    batch.delete(inviteRef);
                    
                    await batch.commit();

                    // UI update is handled automatically by listenForTeamStatus due to onSnapshot listener
                    showToast('success', `Successfully joined team! Dashboard will refresh automatically.`);
                        
                } else if (action === 'decline' || action === 'remove-notif') {
                    // Decline/Dismiss Logic: just delete the invite/notice
                    await deleteDoc(inviteRef);
                    showToast('success', action === 'decline' ? 'Invitation declined.' : 'Notice dismissed.');
                    target.textContent = action === 'decline' ? 'Declined' : 'Dismissed';
                }
            } catch (error) {
                console.error(`Error handling ${action} invitation:`, error);
                showToast('error', `Failed to ${action} invite.`);
                target.textContent = 'Failed';
                setTimeout(() => target.disabled = false, 2000);
            }
        });
        
        // 5. Leave Team / Disband Team Handler
        leaveTeamBtn.addEventListener('click', async () => {
            if (!auth.currentUser || !userTeamId) {
                showToast('error', "You are not currently in a team.");
                return;
            }

            const userId = auth.currentUser.uid;
            const userEmail = auth.currentUser.email.toLowerCase();
            
            // The member object must exactly match the object stored in the array
            const memberToRemove = { uid: userId, name: currentUsername, email: userEmail };
            const teamRef = doc(db, `/artifacts/${APP_ID}/public/data/teams`, userTeamId);

            try {
                // If user is leader, we need more complex logic (transfer leadership or delete team).
                if (userIsTeamLeader) {
                    
                    // 1. Fetch current team details to check member count
                    const teamDocSnap = await getDoc(teamRef);
                    const members = teamDocSnap.data()?.members || [];
                    
                    if (members.length > 1) {
                        // Leader cannot leave if other members exist.
                         showToast('error', "Team Leader must transfer ownership or remove all members before disbanding.");
                         return;
                    } else {
                        // Leader is the only member: Disband the team.
                        await deleteDoc(teamRef);
                        showToast('success', `Team ${userTeamName.toUpperCase()} disbanded successfully.`);
                        return;
                    }
                }
                
                // --- Logic for Regular Member Leaving ---
                await updateDoc(teamRef, {
                    members: arrayRemove(memberToRemove)
                });
                
                showToast('success', `Successfully left team ${userTeamName.toUpperCase()}.`);
                // UI updates automatically via the onSnapshot listener.

            } catch (error) {
                console.error("Error leaving team:", error);
                showToast('error', 'Failed to leave the team.');
            }
        });
        
        // 6. Remove Member Handler (NEW LOGIC) - Attached to ul#teamMemberList
        teamMemberList.addEventListener('click', async (e) => {
            const target = e.target;
            if (target.dataset.action !== 'remove') return;

            if (!userIsTeamLeader || !userTeamId) {
                showToast('error', "Unauthorized action.");
                return;
            }
            
            const memberUid = target.dataset.memberUid;
            const memberName = target.dataset.memberName;
            const memberEmail = target.dataset.memberEmail;
            
            // The object to remove must perfectly match the object in the array
            // CRITICAL FIX: Ensure memberName and memberEmail are used in lowercase
            const memberToRemove = { uid: memberUid, name: memberName.toLowerCase(), email: memberEmail.toLowerCase() };
            const teamRef = doc(db, `/artifacts/${APP_ID}/public/data/teams`, userTeamId);

            try {
                // Remove the user from the members array
                await updateDoc(teamRef, {
                    members: arrayRemove(memberToRemove)
                });
                
                // 2. Send Removal Notification to the removed user's email
                const invitationsRef = collection(db, `/artifacts/${APP_ID}/public/data/invitations`);
                await addDoc(invitationsRef, {
                    inviteeEmail: memberEmail.toLowerCase(), // Ensure lowercase
                    teamId: userTeamId,
                    teamName: userTeamName,
                    inviterName: currentUsername,
                    status: 'removed', // New status for removal notice
                    timestamp: serverTimestamp()
                });
                
                showToast('success', `Member ${memberName.toUpperCase()} removed and notified.`);
                // UI updates automatically via the onSnapshot listener.

            } catch (error) {
                console.error("Error removing member:", error);
                showToast('error', `Failed to remove member ${memberName}.`);
            }
        });

    </script>
</body>
</html>
